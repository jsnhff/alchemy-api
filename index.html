<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Sentimental Book Analysis</title>
        <meta name="description" content="Parse all the words in an XML book and bring back the analysis from Alchemy API. Only 1,000 reuqests a day.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="">
    </head>
    <body>
        <!-- Add your site or application content here -->
        <h1>Testing is happening. Get ready for the long haul.</h1>
        <p id="story"></p>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>
        <script src="js/vendor/rita-micro.js"></script>

        <script>
            // Setup all Alchemy variables
            //var alchemyTextSent = "http://access.alchemyapi.com/calls/url/URLGetTextSentiment";
            var alchemyTextSent = "http://access.alchemyapi.com/calls/text/TextGetTextSentiment";
            var apikey = "eaada21b94f8b0859f447d403dd7f3327652d9c8";
            var sourceText = "https://raw.githubusercontent.com/jsnhff/sentimental-poetry/master/test_doc.xml"; 
            var outputMode = "json";
            var sentiment = "1";
            
            // Make the story available for everyone!
            var story;
            var paragraph;
            var paragraph_number = 0;

            // Silly date and time
            var dt = new Date();
            var time = (24-dt.getHours()) + " hours " + (60-dt.getMinutes()) + " minutes and " + (60-dt.getSeconds()) + " seconds until API refresh.";

            // Load local XML file using ajax -- SUCCESS
            $.ajax({
                type: "GET",
                url: "text/keats-endymion_test.xml",
                dataType: "xml",
                success: function (xml) {

                    // Set story to xml so the xml returned is availabe outside of this call
                    story = xml;

                    // Loop through each paragraph, evaluate each word, then replace it
                    $(xml).find('body paragraph').each(function () {
                        paragraph = $(this);

                            // Define our paragraph so we can replace it easily later
                            paragraph_text = $(this).text();
                            
                            // Tokenize the paragraph so we can send the words off to be evaluated
                            var tokens = RiTa.tokenize(paragraph_text);

                            // Send each word out to be evaluated
                            $(tokens).each(function (index, word) {
                                //paragraph_text = paragraph_text.replace(word, "CATS");
                                //console.log("send word to be evaled");
                                // TODO Remove and punctuation before sending things off to be evaluated 
                                analyzeWord(word, index, paragraph_number);
                                //console.log("Current graph num for "+word+" is: "+paragraph_number);
                            });

                            // Replace original paragraph with new evalutated paragraph
                            //paragraph = paragraph.text(paragraph_text);
                            paragraph_number ++;
                    });

                    // Output the new xml with replaced words
                    console.log(xml);
                    //makeXML();
                }
            });

            // Save our new xml file out to the system. You need a PHP server running to get this going.
            // Use the phpServer alias on the command line, or "php -S 0.0.0.0:8001 -t ."
            var makeXML = function(){
                $.post('save_xml.php', { xml: $(story).find("body").html()}, function(data){alert("Data Loaded: " + data);});
            };

            // Send words to Alchemy to be evaluated 
            var analyzeWord = function(word, target, paragraph_number){
                // Query to find sentiment in a whole URL 
                // var urlQuery = alchemyTextSent + "?url=" + sourceText + "&apikey=" + apikey + "&outputMode=" + outputMode;

                // Query to find sentiment in raw text or one word. One word is assumed to be English.
                var urlQuery = alchemyTextSent + "?&apikey=" + apikey + "&text=" + word + "&outputMode=" + outputMode;

                // Async function to evaluate each word passed to the parent function 
                $.ajax({
                    url: urlQuery,
                    success: function(results) {

                        // If I'm out of requests, let me know and I'll switch projects or just kick back and relax
                        if(results.status == "ERROR") {
                            $("h1").text("Good job on testing champ. You're out of requests for the day. Better luck tomorrow.").append("<h3>"+time+"</h3>");
                            
                            // Replace the word in the original story. This belongs in the success bucket, not the error bucket. It's just here for testing.
                            $(story).find('body paragraph').each(function(index) {
                                paragraph = $(this);
                                
                                // Define our paragraph so we can replace it easily later
                                paragraph_text = paragraph.text();

                                // Make sure we're replacing words evalutated in the correct paragraph
                                if(index == paragraph_number) {
                                    var chosenValue = Math.random() < 0.5;

                                    // Dummy if to randomly wrap words in positive or negative tags.
                                    // TODO Remove this mock logic and bring back the actual evaluation
                                    if(chosenValue > 0) {
                                        paragraph_text = paragraph_text.replace(word, '<positive value="'+index+'">'+word+'</positive>');
                                        } else {
                                        paragraph_text = paragraph_text.replace(word, '<negative value="'+index+'">'+word+'</negative>');
                                    };
                                    //console.log("Paragraph "+paragraph_number+"--"+index+": "+paragraph_text); 
                                };
                                paragraph = paragraph.text(paragraph_text);
                            });

                        } else {
                            $("h1").text("Bingo. Testing time.");
                            console.log("Success: " + target + " " + word + " Analysis: " + results.docSentiment.type +"  "+ results.docSentiment.score);
                            
                            // TODO Put replacing code above here once the API requests are ready to use :D 

                        };
                        
                        // TODO This could be useful once you have the API up again. You'll need to account for the null scenario.
                        //if (results.docSentiment.score == null){
                        //    var score = "0.000000";
                        //} else {
                        //    var score = results.docSentiment.score;
                        //};
                        //$("#"+target).addClass(results.docSentiment.type).attr("data-value", score).text(word);

//                    makeXML();
                    }
                });
            }
        </script>
    </body>
</html>
